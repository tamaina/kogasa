<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>kogasa - waifu2x frontend</title>
    <link rel="stylesheet" href="./assets/mdl/material.min.css">
    <link rel="stylesheet" href="./assets/mdl/mdl-selectfield.min.css">
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./assets/fa/css/font-awesome.min.css">
    <script src="./assets/mdl/material.min.js"></script>
    <script src="./assets/mdl/mdl-selectfield.min.js"></script>
    <script>
    const cwd = process.cwd()
    let _module_exports = module.exports,
        _noderequire = window.require
    delete module.exports
    const $ = window.jQuery = require('./assets/jquery/jquery.min.js')
    module.exports = _module_exports
    window.require = _noderequire
    delete _jquery
    delete _require
    delete _module_exports
    const fs = require('fs')
          ncrypto = require('crypto')
          nextend = require('extend')
          tmp = require('tmp')
          execSync = require('child_process').execSync
    const DEBUG = true
          setting_path = "./setting.json"
          i18n = {}
          i18n["here"] = require('./locales/' + window.navigator.language + '.json')
          i18n.ja = require('./locales/ja.json')
          display_files_chosen_selector = "#files_chosen"
          display_files_reserved_selector = "#files_reserved"
          display_files_running_selector = "#files_running"
          display_files_finished_selector = "#files_finished"
          w2xbin = "w2xbin\\"
          temp = "" + tmp.tmpdir + "\\kogasa"
          tmp_ext = "png"
      let files_chosen = []
          files_reserved = {}
          files_running = {}
          files_finished = {}
          PAUSE = false
      // settingの素(settingが無い場合の初期値決定、およびサジェスト用)
      let setting = {
          "waifu2x": {
              "binarys": {
                  "waifu2x-converter-cpp": {
                      "more_option": ""
                  },
                  "waifu2x-caffe-cui": {
                      "more_option": "-p cpu"
                  }
              },
              "use": "waifu2x-caffe-cui"
          },
          "model": {
              "vendors": [
                  {
                      "name": "vgg_7",
                      "description": {
                          "ja": "標準的な処理方法です。",
                          "en": "Default"
                      },
                      "images": [
                          {
                              "name": "art",
                              "description": {
                                  "ja": "アニメや漫画の絵を変換するのに適しています。",
                                  "en": "For paint as anime and manga."
                              }
                          },
                          {
                              "name": "art_y",
                              "description": {
                                  "ja": "アニメや漫画の絵を変換するのに適しています。画像の輝度Y成分のみ変換します。",
                                  "en": "For paint as anime and manga. It converts only \"Y\" data."
                              }
                          },
                          {
                              "name": "photo",
                              "description": {
                                  "ja": "写真を変換するのに適しています。",
                                  "en": "For photograph."
                              }
                          }
                      ],
                      "image_val": "art_y"
                  },
                  {
                      "name": "upconv_7",
                      "description": {
                          "ja": "vgg_7より高品質・高速ですが、VRAM(メモリー)使用量が増えます。",
                          "en": "Great but heavy"
                      },
                      "images": [
                          {
                              "name": "art",
                              "description": {
                                  "ja": "アニメや漫画の絵を変換するのに適しています。",
                                  "en": "For paint as anime and manga."
                              }
                          },
                          {
                              "name": "photo",
                              "description": {
                                  "ja": "写真を変換するのに適しています。",
                                  "en": "For photograph."
                              }
                          }
                      ],
                      "image_val": "photo"
                  }
              ],
              "vendor": "vgg_7"
          },
          "scale_ratio": {
              "auto": true,
              "scale_ratio": "2",
              "max_width": 1920,
              "max_height": 1080,
              "min_width": "1",
              "min_height": "0"
          },
          "noise_level": "0",
          "auto_scale": true,
          "file_formats": {
              "png": {
                  "enable": true,
                  "mime": "image/png",
                  "lossy": false,
                  "animateable": false,
                  "chrome_supported": true,
                  "w2x_supported": true,
                  "extentions": [
                      "png"
                  ],
                  "output_option": ""
              },
              "jpeg": {
                  "enable": true,
                  "mime": "image/jpeg",
                  "lossy": true,
                  "animateable": false,
                  "chrome_supported": true,
                  "w2x_supported": true,
                  "extentions": [
                      "jpeg",
                      "jpg"
                  ]
              },
              "tiff": {
                  "enable": true,
                  "mime": "image/tiff",
                  "lossy": true,
                  "animateable": false,
                  "chrome_supported": true,
                  "w2x_supported": true,
                  "extentions": [
                      "tif",
                      "tiff"
                  ],
                  "output_option": ""
              },
              "bmp": {
                  "enable": true,
                  "mime": "image/bmp",
                  "lossy": false,
                  "animateable": false,
                  "chrome_supported": true,
                  "w2x_supported": true,
                  "extentions": [
                      "bmp"
                  ]
              },
              "gif": {
                  "enable": true,
                  "mime": "image/gif",
                  "lossy": false,
                  "animateable": true,
                  "chrome_supported": true,
                  "w2x_supported": true,
                  "extentions": [
                      "gif"
                  ],
                  "output_option": ""
              },
              "targa": {
                  "enable": true,
                  "mime": "image/x-targa",
                  "lossy": true,
                  "animateable": true,
                  "chrome_supported": true,
                  "w2x_supported": true,
                  "extentions": [
                      "gif"
                  ],
                  "output_option": ""
              },
              "bpg": {
                  "enable": true,
                  "mime": "image/x-bpg",
                  "lossy": false,
                  "animateable": true,
                  "chrome_supported": false,
                  "w2x_supported": false,
                  "extentions": [
                      "bpg"
                  ],
                  "output_option": "lossless=true"
              },
              "webp": {
                  "enable": true,
                  "mime": "image/x-webp",
                  "lossy": false,
                  "animateable": true,
                  "chrome_supported": true,
                  "w2x_supported": false,
                  "extentions": [
                      "webp"
                  ],
                  "output_option": "-lossless"
              },
              "mp4": {
                  "enable": true,
                  "mime": "video/mp4",
                  "lossy": true,
                  "animateable": true,
                  "chrome_supported": true,
                  "w2x_supported": false,
                  "extentions": [
                      "gif"
                  ],
                  "output_option": ""
              }
          },
          "output": {
              "path": "",
              "file_format": "webp"
          },
          "parallel": "10",
          "log": [],
          "scale_down_ratio": 1
      }
    if(DEBUG) console.log(setting)
      let savedata = require(setting_path)
    if(DEBUG) console.log(savedata)
      setting = nextend(setting,savedata)
      
    if(DEBUG) console.log(setting)
  
    if(DEBUG) console.log(temp)
    if(DEBUG) console.log(i18n)
    if(DEBUG) console.log(cwd)
    if(DEBUG) console.log((String.fromCharCode.apply(null, new Uint8Array(execSync("cd")))))


    $(document).on('dragover drop',function(e) {
      e.preventDefault()
      return false
    })

    $(function(){

      /* *************************************************************** */
      /*                                                                 */
      /* 設定入出力                                                      */
      /*                                                                 */
      /* *************************************************************** */

      // 終了時setting.jsonを書き換える。
      $(document).on("close",function(){
        let timestamp = new Date()
        setting.log.push([timestamp.toISOString()])
        save()
      })

      function save(){
        let timestamp = new Date()
        if(DEBUG) console.log("Setting changed and saved at " + timestamp.toISOString())
        componentHandler.upgradeDom('input,textarea,select');
        fs.writeFile(setting_path, JSON.stringify(setting,null,4))
      }


      /* *************************************************************** */
      /*                                                                 */
      /* 映像・画像入出力                                                */
      /*                                                                 */
      /* *************************************************************** */
  
      // 関数type()……File APIを読み取りファイルタイプを出力
      //               returntypeはtextかisReadable
      function type(file,returntype){ 
        if(DEBUG) console.log(file)
        let answer = false
        try{
          fs.statSync(file.path)
        } catch(e){
          return false
        }
        if(fs.statSync(file.path).isDirectory()){
          switch(returntype){
            case 'text': answer = "directory"; break;
            case 'isReadable' : answer = false; break;
            case 'isDirectory': answer = true; break;
            case 'isEnable' : answer = true; break;
          }
        } else {
          // if(DEBUG) console.log(file.type)
          switch(returntype){
            case 'text': 
              if( file.type != undefined && file.type != "" ) answer = file.type
              else if(type(file,"isReadable")) answer = setting.file_formats[type(file,"isReadable")].mime
              else answer = false
              break
            case 'isReadable' : 
              for( var key in setting.file_formats ){
                // if(DEBUG) console.log(key + ",mime:" + setting.file_formats[key].mime)
                if(setting.file_formats[key].mime == file.type ){
                  answer = key
                } else {
                  for(let i = 0; i < setting.file_formats[key].extentions.length; i++){
                    // if(DEBUG) console.log("." + setting.file_formats[key].extentions[i])
                    if(file.name.slice(setting.file_formats[key].extentions[i]) == setting.file_formats[key].extentions[i]){
                      answer = key
                    }
                    if(!answer) break
                  }
                }
              }
              break
            case 'isDirectory': answer = false; break;
            case 'isEnable':
              for( let key in setting.file_formats ){
                if(setting.file_formats[key].enable && [key] == type(file,"isReadable")){ answer = true; break; }
              }
              break;
          }
        }
        if(DEBUG) console.log(answer)
        return answer
      }

      // 関数changed_files_list()……ファイルを入力/削除した時に実行し、ファイル一覧の変更をする
      function changed_files_list(){
        let files_chosen_html = ""
            files_reserved_html = ""
            files_running_html = ""
            files_finished_html = ""
            delete_html_before = "<a href='javascript:void(0)' class='mdl-button mdl-js-button mdl-button--icon delete-chosen-file' name='delete_chosen_file_"
            delete_html_after = "'>&times;</a>"

        if(DEBUG) console.table(files_chosen)
        // 選択済みファイルの出力
        for(let i = 0; i < files_chosen.length; i++){
          let numbering = i + 1
              _this = files_chosen[i]
              mimetype = type(_this,'text')
              isReadable = type(_this,'isReadable')
              
          files_chosen_html += `<p class="changeable p-0 m-0">${numbering} <img src="${_this.path}" style="height: 2em" />${delete_html_before}${i}${delete_html_after}${_this.path}(${mimetype}`
          if(DEBUG) console.log(isReadable)
          if(isReadable){
            if(DEBUG) console.log(_this.image.width+"x"+_this.image.height)
            files_chosen_html += "," + isReadable + "," + Number(_this.size) + "," + _this.image.width + "x" + _this.image.height + ")" + "</p>"
          } else {
            files_chosen_html +=")" + "</p>"
          }
        }
        if(files_chosen_html.length < 2) files_chosen_html = "%i18n:text.files.nofile%"
        $(display_files_chosen_selector).html(files_chosen_html.replace(/%i18n:(.+?)%/g,replace_i18n))
        
        if(DEBUG) console.table(files_reserved)

        // 待機中ファイル一覧の出力
        if(files_reserved){
        for(let key in files_reserved){
          let _this = files_reserved[key].file
              mimetype = type(_this,'text')
              isReadable = type(_this,'isReadable')
          if(DEBUG) console.table()
          files_reserved_html += "<p class='changeable pb-0'>" + "id:" + key + " (" + mimetype + "," + isReadable + "," + Number(_this.size) + "," + _this.image.width + "x" + _this.image.height + ")" + "</p>"
        }
        if(files_reserved_html.length < 2) files_reserved_html = "%i18n:text.files.nofile%"
        $(display_files_reserved_selector).html(files_reserved_html.replace(/%i18n:(.+?)%/g,replace_i18n))
        }
        // 処理中ファイル一覧の出力
        if(files_running){
        for(let key in files_running){
          let _this = files_running[key].file
              mimetype = type(_this,'text')
              isReadable = type(_this,'isReadable')
          if(DEBUG) console.table()
          files_running_html += "<p class='changeable pb-0'>" + "id:" + key + " (" + mimetype + "," + isReadable + "," + Number(_this.size) + "," + _this.image.width + "x" + _this.image.height + ")" + "</p>"
        }
        if(files_running_html.length < 2) files_running_html = "%i18n:text.files.nofile%"
        $(display_files_running_selector).html(files_running_html.replace(/%i18n:(.+?)%/g,replace_i18n))
        }
        // 終了ファイル一覧の出力
        if(files_finished){
        for(let key in files_finished){
          let _this = files_finished[key].file
              mimetype = type(_this,'text')
              isReadable = type(_this,'isReadable')
          if(DEBUG) console.table()
          files_finished_html += "<p class='changeable pb-0'>" + "id:" + key + " (" + mimetype + "," + isReadable + "," + Number(_this.size) + "," + _this.image.width + "x" + _this.image.height + ")" + "</p>"
        }
        if(files_finished_html.length < 2) files_finished_html = "%i18n:text.files.nofile%"
        $(display_files_finished_selector).html(files_finished_html.replace(/%i18n:(.+?)%/g,replace_i18n))
        }
        $(".delete-chosen-file").off('click')
        $(".delete-chosen-file").on("click",function(){
          if(DEBUG) console.log("delete!")
          let index = 0
          index = $(".delete-chosen-file").index(this)
          if(DEBUG) console.log(index)
          if( files_chosen.length > 1 ) files_chosen.splice( Number(index) , 1 )
          else files_chosen = []
          changed_files_list()
        })

      }

      // DD時の動作
      $(document).on('drop',function(e){
        e.preventDefault();
        let this_input = e.originalEvent.dataTransfer.files
        let buffer = new Array
        // 分別なくimage要素を押し込みます
        for(let i = 0; i < e.originalEvent.dataTransfer.files.length; i++){
          let _this = e.originalEvent.dataTransfer.files[i]
              image= new Image
          let isDirectory =type(_this,'isDirectory')
          image.src=_this.path
          e.originalEvent.dataTransfer.files[i].image = image
          if(DEBUG) console.log(image)
          e.originalEvent.dataTransfer.files[i].before = {}
          e.originalEvent.dataTransfer.files[i].before.image = image
          e.originalEvent.dataTransfer.files[i].before.d = _this.path.substr(0,3)
          e.originalEvent.dataTransfer.files[i].before.p = _this.path.substr(3, _this.path.length - 3 - _this.name.length)
          if(isDirectory){
            e.originalEvent.dataTransfer.files[i].before.n = _this.name
            e.originalEvent.dataTransfer.files[i].before.x = ""
          } else {
            e.originalEvent.dataTransfer.files[i].before.n = _this.name.slice(0,_this.name.lastIndexOf("."))
            e.originalEvent.dataTransfer.files[i].before.x = _this.name.substr(_this.name.lastIndexOf("."))
          }
        }
        if(DEBUG) console.table(this_input)
        if(DEBUG) console.table(files_chosen)
        Array.prototype.push.apply(buffer,this_input)
        Array.prototype.push.apply(buffer,files_chosen)
        files_chosen = buffer.filter(function(element, index, array){
          if(DEBUG) console.log(element)
          if(DEBUG) console.log(index)
          if(DEBUG) console.log(array)
          var can_add = true
          for(let i = 0; i < array.length; i++){
            if( i != index && array[i].path == element.path ) can_add = false
            else if(i == index) can_add = true
          }
          if(DEBUG) console.log(can_add)
          return can_add
        })
        setTimeout(changed_files_list,100)
      })


      
      function rmdirForceSync(path) {
        try {
          fs.statSync(path);
        } catch(e) {
          if(e.code === 'ENOENT') return false
        }
        log = execSync(`rmdir /s /q "${path}"`)
        if(DEBUG) console.log(String.fromCharCode.apply(null, new Uint8Array(log)))
      }
      rmdirForceSync(temp)
      try{
        fs.mkdirSync(temp)
      }catch(e){}
      /* *************************************************************** */
      /*                                                                 */
      /* コマンドの実行                                                  */
      /*                                                                 */
      /* *************************************************************** */
      // 実行ボタン監視
      $("button[name='do']").on('click',function(e){
        e.preventDefault()
        if(DEBUG) console.log(files_chosen)
        if(files_chosen == []) return false
        for(let i = 0; i < files_chosen.length; i++ ){
          if(setting.file_formats[type(files_chosen[i],"isReadable")].animateable && type(files_chosen[i],"isEnable")){
            mov_register(files_chosen[i])
          } else if(type(files_chosen[i],"isEnable")){
            img_register(files_chosen[i])
          } else if(type(files_chosen[i],'isDirectory')) {
            dir_register(files_chosen[i].path,files_chosen[i].before)
          }
        }
        files_chosen = []
        if(files_reserved != {}){
          for(let i = 0; i < setting.parallel; i++){
            setTimeout(converter,i*128)
          }
        }
        changed_files_list()
        
      })
      $("button[name='DEL']").on('click',function(e){ e.preventDefault(); files_chosen = []; rmdirForceSync(temp);
        try{
          fs.mkdirSync(temp)
        }catch(e){}
        changed_files_list() })
      $("button[name='PAUSE']").on('click',function(e){ e.preventDefault(); 
        if(PAUSE){
          PAUSE = false
          if(files_reserved != {}){
            for(let i = 0; i < setting.parallel; i++){
              setTimeout(converter,i*128)
            }
          }
        } else {
          PAUSE = true
        }
    
      })

      function converter(){
        for(let id in files_reserved){
          files_running[id] = files_reserved[id]
          delete files_reserved[id]
          files_running[id].process.log = {}
          let timestamp = new Date()
          let command = ""
          files_running[id].process.tmpdpn = `${temp}\\${id}`
          files_running[id].process.tmpdpnx = `${files_running[id].process.tmpdpn}.${tmp_ext}`
          files_running[id].process.log[timestamp.toISOString()] = "CONVERT STARTED"
          files_running[id].process.t = 0

          setTimeout(changed_files_list(),500)
          do{
            if(files_running[id].process.t == 0){
              if(files_running[id].order.scale_down_ratio != 1){
                timestamp = new Date()
                command = `magick convert -resize ${files_running[id].order.scale_down_ratio * 100}% -unsharp ${files_running[id].order.scale_down_unsharp} -verbose "${files_running[id].file.path}" "${files_running[id].process.tmpdpnx}" `
                files_running[id].process.log[timestamp.toISOString()] = execSync(command)
                if(DEBUG) console.log(command)
                if(DEBUG) console.log(String.fromCharCode.apply(null, new Uint8Array(files_running[id].process.log[timestamp.toISOString()])))
            } else {
                timestamp = new Date()
                command = `magick convert -verbose "${files_running[id].file.path}" "${files_running[id].process.tmpdpn}.${tmp_ext}"`
                files_running[id].process.log[timestamp.toISOString()] = execSync(command)
                if(DEBUG) console.log(command)
                if(DEBUG) console.log(String.fromCharCode.apply(null, new Uint8Array(files_running[id].process.log[timestamp.toISOString()])))
              }
              if(files_running[id].order.noise_level > 0 && files_running[id].order.file_formats[files_running[id].file.file_format].lossy) files_running[id].process.noise = true
              else if(files_running[id].order.noise_level > 0 && !files_running[id].order.auto_scale) files_running[id].process.noise = true
              else files_running[id].process.noise = false
            }

            function search_vendor(id){
              for(let x = 0; x < files_running[id].order.model.vendors.length; x++){
                if( files_running[id].order.model.vendor == files_running[id].order.model.vendors[x].name ) return x
              }
            }
            let x = search_vendor(id)

            if(files_running[id].process.noise){
              timestamp = new Date()
              command = `${w2xbin}${files_running[id].order.waifu2x.use} -m noise ${files_running[id].order.waifu2x.binarys[files_running[id].order.waifu2x.use].more_option.replace("\n"," ")} -n ${files_running[id].order.noise_level} --model_dir ${w2xbin}models\\${files_running[id].order.model.vendor}\\${files_running[id].order.model.vendors[x].image_val} -i "${files_running[id].process.tmpdpnx}" -o "${files_running[id].process.tmpdpnx}"`
              files_running[id].process.log[timestamp.toISOString()] = execSync(command)
              files_running[id].process.t++
              if(DEBUG) console.log(command)
              if(DEBUG) console.log(String.fromCharCode.apply(null, new Uint8Array(files_running[id].process.log[timestamp.toISOString()])))
            }
            if( files_running[id].process.scale_ratio > 1 ){
              timestamp = new Date()
              command = `${w2xbin}${files_running[id].order.waifu2x.use} -m scale ${files_running[id].order.waifu2x.binarys[files_running[id].order.waifu2x.use].more_option.replace("\n"," ")} -s 2 --model_dir ${w2xbin}models\\${files_running[id].order.model.vendor}\\${files_running[id].order.model.vendors[x].image_val} -i "${files_running[id].process.tmpdpnx}" -o "${files_running[id].process.tmpdpnx}"`
              files_running[id].process.log[timestamp.toISOString()] = execSync(command)
              files_running[id].process.t++
              if(DEBUG) console.log(command)
              if(DEBUG) console.log(String.fromCharCode.apply(null, new Uint8Array(files_running[id].process.log[timestamp.toISOString()])))
            }

            files_running[id].process.scale_ratio = files_running[id].process.scale_ratio / 2
            files_running[id].process.noise = false
          } while( files_running[id].process.scale_ratio > 1 )

          files_running[id].process.resize_set = ""
          if(files_running[id].order.scale_auto && files_running[id].process.scale_whichis == "width") files_running[id].process.resize_set = `-resize ${files_running[id].order.scale_ratio.min_width}x -unsharp ${files_running[id].order.scale_down_unsharp} `
          if(files_running[id].order.scale_auto && files_running[id].process.scale_whichis == "height") files_running[id].process.resize_set = `-resize x${files_running[id].order.scale_ratio.min_height} -unsharp ${files_running[id].order.scale_down_unsharp} `
          if(!files_running[id].order.scale_auto && files_running[id].process.scale_whichis == "width") files_running[id].process.resize_set = `-resize ${files_running[id].file.before.image.width * files_running[id].order.scale_ratio.scale_ratio / files_running[id].order.scale_down_ratio}x -unsharp ${files_running[id].order.scale_down_unsharp} `
          if(!files_running[id].order.scale_auto && files_running[id].process.scale_whichis == "height") files_running[id].process.resize_set = `-resize x${files_running[id].file.before.image.height * files_running[id].order.scale_ratio.scale_ratio / files_running[id].order.scale_down_ratio} -unsharp ${files_running[id].order.scale_down_unsharp} `

          if(files_running[id].order.output.path == "") files_running[id].order.output.path = `${files_running[id].file.before.d}${files_running[id].file.before.p}`
          files_running[id].process.outname = `waifued_${files_running[id].file.before.n}`
          try{
            fs.mkdirSync(files_running[id].order.output.path)
          }catch(e){}
          timestamp = new Date()
          command = `magick convert ${files_running[id].process.resize_set} ${files_running[id].order.file_formats[files_running[id].order.output.file_format].output_option.replace("\n"," ")} -verbose "${files_running[id].process.tmpdpnx}" "${files_running[id].order.output.path}${files_running[id].process.outname}.${files_running[id].order.output.file_format}"`
          files_running[id].process.log[timestamp.toISOString()] = execSync(command)
          if(DEBUG) console.log(command)
          if(DEBUG) console.log(String.fromCharCode.apply(null, new Uint8Array(files_running[id].process.log[timestamp.toISOString()])))
          fs.unlinkSync(files_running[id].process.tmpdpnx)
          files_finished[id] = files_running[id]
          delete files_running[id]
          break;
        }
        if(!PAUSE) setTimeout(changed_files_list(),500)
      }

      // 動画・アニメーション登録
      function mov_register(file){
        if(DEBUG) console.log(file.name + " register as movie")
        let dist = `${temp}\\anm\\${file.before.n}`
        let log,
            logstr
        try{
          fs.mkdirSync(`${temp}\\anm`)
        }catch(e){}
        try{
          fs.mkdirSync(dist)
        }catch(e){}
        execSync(`ffmpeg -i "${file.path}" -f image2 -vcodec ${tmp_ext} "${dist}\\%09d.${tmp_ext}"`)
        if(fs.readdirSync(dist).length == 1){
          rmdirForceSync(dist)
          img_register(file)
          return false
        }
        log = execSync(`magick identify "${dist}\\000000001.${tmp_ext}"`)
        logstr = String.fromCharCode.apply(null, new Uint8Array(log))
        let str_x = logstr.split(" ")[3].split("x")
        let str_w = str_x[0]
        let str_h = str_x[1].split("+")[0]
        if(DEBUG) console.log([str_x,str_w,str_h])
        file.before.image.width = str_w
        file.before.image.height = str_h
        dir_register(dist,file.before)
      }
      
      function dir_register(path,before){
        if(DEBUG) console.log(path + " register as directory")
        fs.readdirSync(path).forEach(function(name,index){
          if(DEBUG) console.log(name)
          let image= new Image
              zfile = {}
          zfile.before = before
          zfile.before.d = before.d
          zfile.before.p = `${before.p}${before.n}_waifued\\`
          try{
            fs.mkdirSync(`${zfile.before.d}${zfile.before.p}`)
          }catch(e){}
          zfile.before.n = name.slice(0,name.lastIndexOf("."))
          zfile.before.x = name.substr(name.lastIndexOf("."))
          zfile.path = `${path}\\${name}`
          if(DEBUG) console.log(zfile.path)
          image.src=zfile.path
          if(DEBUG) console.log(zfile.image)
          zfile.image = image
          zfile.image.width = before.image.width
          zfile.image.height = before.image.height
          zfile.name = name
          if(DEBUG) console.log(image)
          zfile.type = `image/${tmp_ext}`
          if(DEBUG) console.log(zfile)
          setTimeout(img_register(zfile),1000)
        })
      }

      // 画像登録(最終)
      function img_register(zfile){
        let timestamp = new Date()
        if(DEBUG) console.log("started at " + timestamp.toISOString())
        let id = get_hash(timestamp.toISOString())
        files_reserved[id] = {}
        files_reserved[id]["file"] = zfile
        files_reserved[id]["file"]["file_format"] = type(zfile,'isReadable')
        files_reserved[id]["order"] = setting
        files_reserved[id]["process"] = {}
        files_reserved[id].process.scale_ratio = scale_ratio_register(id)
        files_reserved[id].process.scale_whichis = scale_whichis(id)
        if(DEBUG) console.log(files_reserved[id])
      }

      // scale_ratio確定
      function scale_ratio_register(id){
        if(files_reserved[id].order.scale_ratio.auto){
          if(DEBUG) console.log(files_reserved[id].file.image.width)
          let ratio_h = 0
              ratio_w = 0
          if(files_reserved[id].order.scale_ratio.min_width > 0){
            ratio_w = files_reserved[id].order.scale_ratio.min_width / files_reserved[id].file.before.image.width / files_reserved[id].order.scale_down_ratio
          } else {
            ratio_w = 1
          }
          if(files_reserved[id].order.scale_ratio.min_height > 0){
            ratio_h = files_reserved[id].order.scale_ratio.min_height / files_reserved[id].file.before.image.height / files_reserved[id].order.scale_down_ratio
          } else {
            ratio_h = 1
          }
          if(DEBUG) console.log("w:"+ ratio_w)
          if(DEBUG) console.log("h:"+ ratio_h)
          if( ratio_w < ratio_h ) return ratio_h
          if( ratio_w > ratio_h ) return ratio_w
        } else {
          return files_reserved[id].order.scale_ratio.scale_ratio / files_reserved[id].order.scale_down_ratio
        }
      }

      function scale_whichis(id){
        if(DEBUG) console.log(files_reserved[id].file.image.width)
        let ratio_h = 0
            ratio_w = 0
        if(files_reserved[id].order.scale_ratio.auto){
          if(files_reserved[id].order.scale_ratio.min_width > 0){
            ratio_w = files_reserved[id].order.scale_ratio.min_width / files_reserved[id].file.before.image.width
          } else {
            ratio_w = 0
          }
          if(files_reserved[id].order.scale_ratio.min_height > 0){
            ratio_h = files_reserved[id].order.scale_ratio.min_height / files_reserved[id].file.before.image.height
          } else {
            ratio_h = 0
          }
        } else {
          ratio_w = files_reserved[id].file.before.image.width * files_reserved[id].order.scale_ratio.scale_ratio / files_reserved[id].order.scale_down_ratio
          ratio_w = files_reserved[id].file.before.image.width * files_reserved[id].order.scale_ratio.scale_ratio / files_reserved[id].order.scale_down_ratio
        }
        if(DEBUG) console.log("w:"+ ratio_w)
        if(DEBUG) console.log("h:"+ ratio_h)
        if( ratio_w < ratio_h ) return "height"
        if( ratio_w > ratio_h ) return "width"
      }
      // id発行
      function get_hash(timestamp) {
        if(DEBUG) console.log(crypto)
        return ncrypto.createHash('sha1').update(timestamp).digest("hex")
      }

      /* *************************************************************** */
      /*                                                                 */
      /* 設定フォームの生成・検知                                        */
      /*                                                                 */
      /* *************************************************************** */


      /////////////////////////////////////////////////////////////////
      // w2xbins                                                     //
      // 利用するバイナリ                                            //
      /////////////////////////////////////////////////////////////////
      function w2xbins_html(){
        let answer=""
        for(let key in setting.waifu2x.binarys){
          let _this = setting.waifu2x.binarys[key]
          answer+=`
          <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="w2xbin_${key}">
            <input type="radio" id="w2xbin_${key}" name="w2xbins" value="${key}" class="mdl-radio__button">
            <span class="mdl-radio__label">${key}.exe</span>
          </label>
          `
        }
        return answer
      }
      $("#w2xbins").html(w2xbins_html())

      // 初期設定処理
      $("input[name='w2xbins']").prop("checked",false)
      $("input[name='w2xbins'][value='"+ setting.waifu2x.use +"']").prop("checked",true).trigger('change')
      $("textarea#w2x_option").val(setting.waifu2x.binarys[setting.waifu2x.use].more_option).trigger('change')

      // 変更検知
      $("input[name='w2xbins']").on('change',function(){
        setting.waifu2x.use = $(this).val()
        $("textarea#w2x_option").val(setting.waifu2x.binarys[$(this).val()].more_option)
        save()
      })
      $("textarea#w2x_option").on('change',function(){
        setting.waifu2x.binarys[$("input[name='w2xbins']:checked").val()].more_option = $(this).val()
        save()
      })
      
      /////////////////////////////////////////////////////////////////
      // model                                                       //
      // 利用するモデル                                              //
      /////////////////////////////////////////////////////////////////
      function model_vendor_html(){
        let answer=""
        let images_form=""
        for(let i = 0; i < setting.model.vendors.length; i++){
          let _this = setting.model.vendors[i]
          answer+=`<option value="${_this.name}" data-number="${i}">${_this.name}</option>
          `
          images_form += model_image_html(i)
        }
        $("#model_image_wrap").html(images_form.replace(/%i18n:(.+?)%/g,replace_i18n))
        return answer
      }
      function model_image_html(i){
        let vendor_name = setting.model.vendors[i].name
        let answer=""
        answer+=`
                <div class="mdl-selectfield mdl-js-selectfield model_image_selectfields_wrap mdl-textfield--floating-label p-0" id="model_image_${vendor_name}" data-vendor="${vendor_name}" data-vendor-number="${i}">
                  <select id="selectform_model_image_${vendor_name}" class="mdl-selectfield__select model_image_selectfield" data-vendor="${vendor_name}" data-vendor-number="${i}">
        `
        for(let j = 0; j < setting.model.vendors[i].images.length; j++){
          let _this = setting.model.vendors[i].images[j]
          answer += `<option value="${_this.name}" data-number="${j}">${_this.name}</option>
          `
        }
        answer+=`
                  </select>
                  <label class="mdl-selectfield__label" for="selectform_model_image_${vendor_name}"></label>
                  <span class="mdl-selectfield__error">%i18n:text.error.selectavalue%</span>
                </div>
        `
        return answer
      }
      $("#model_vendor").html(model_vendor_html)

      // 初期設定処理
      $("#model_vendor").val(setting.model.vendor)
      for(let i = 0; i < setting.model.vendors.length; i++){
        if(setting.model.vendors[i].name == setting.model.vendor){
          $("#model_vendor_description").html(function(){
            let a = setting.model.vendors[i].description[window.navigator.language]
            if(a == undefined) a = setting.model.vendors[o].description.ja
            else if(a == undefined) a = ""
            return a
          })
        break
        }
      }

      function model_image_change(vendor_num){
        $(".model_image_selectfields_wrap").hide()
        $(".model_image_selectfields_wrap[data-vendor-number='"+ vendor_num +"']").show()
        $(".model_image_selectfield[data-vendor-number='"+ vendor_num +"']").val(setting.model.vendors[vendor_num].image_val).trigger('change')
      }
      // 変更検知
      $("#model_vendor").on("change",function(){
        if(DEBUG) console.log(this)
        let vendor_num = $(`#model_vendor option[value="${$('#model_vendor').val()}"]`).attr("data-number")
        setting.model.vendor =$(this).val()
        $("#model_vendor_description").html(function(){
          let a = setting.model.vendors[vendor_num].description[window.navigator.language]
          if(a == undefined) a = setting.model.vendors[vendor_num].description.ja
          else if(a == undefined) a = ""
          return a
        })
        model_image_change(vendor_num)
        save()
      })
      $(".model_image_selectfield").on("change",function(){
        if(DEBUG) console.log(this)
        let vendor_num = $(this).attr("data-vendor-number")
            image_num = $(`.model_image_selectfield[data-vendor-number="${vendor_num}"] option[value="${$(this).val()}"]`).attr("data-number")
        setting.model.vendors[vendor_num].image_val = $(this).val()
        save()
        $("#model_image_description").html(function(){
          let a = setting.model.vendors[vendor_num].images[image_num].description[window.navigator.language]
          if(a == undefined) a = setting.model.vendors[vendor_num].images[image_num].description.ja
          else if(a == undefined) a = ""
          return a
        })
        save()
      })

      model_image_change($(`option[value="${setting.model.vendor}"]`).attr("data-number"))


      /////////////////////////////////////////////////////////////////
      // noise_level                                                 //
      // デノイズレベル                                              //
      /////////////////////////////////////////////////////////////////
      // 初期設定
      $("#noise_level").on("input change",function(){
        if(DEBUG) console.log($(this).val())
        setting.noise_level = $(this).val()
        $("#noise_level_disp").html($(this).val())
        save()
      }).on("focus",function(){
        $("#noise_level_disp").attr("style","border-bottom:2px solid rgb(0,150,136)")
      }).on("mouseleave",function(){
        $("#noise_level_disp").attr("style","1px solid rgba(0,0,0,.12)")
      })
      $("#noise_level").get(0).MaterialSlider.change(setting.noise_level)
      $("#noise_level").trigger("change")
      function auto_scale_wrap_html(){
        let answer=""
            checked=""
        if(setting.auto_scale == true) checked += "checked"
        answer+=`
          <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="auto_scale" id="auto_scale_label">
            <input type="checkbox" name"auto_scale" id="auto_scale" class="mdl-switch__input" ${checked}>
            <span class="mdl-switch__label">%i18n:text.setting.noise.autoscale%</span>
          </label>
        `
        return answer
      }
      $("#auto_scale_wrap").html(auto_scale_wrap_html().replace(/%i18n:(.+?)%/g,replace_i18n))
      $("#auto_scale").trigger("change")
      $("#auto_scale").on("change",function(){
        setting.auto_scale = $(this).prop("checked")
        save()
      })


      /////////////////////////////////////////////////////////////////
      // sclae_ratio                                                 //
      // 拡大率                                                      //
      /////////////////////////////////////////////////////////////////
      function scale_auto_switch_html(){
        let answer=""
            checked=""
        if(setting.scale_ratio.auto == true) checked += "checked"
        answer+=`
          <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="scale_auto" id="scale_auto_label">
            <input type="checkbox" name"scale_auto" id="scale_auto" class="mdl-switch__input" ${checked}>
            <span class="mdl-switch__label">%i18n:text.setting.scale.auto%</span>
          </label>
        `
        return answer
      }
      $("#scale_auto_switch_wrap").html(scale_auto_switch_html().replace(/%i18n:(.+?)%/g,replace_i18n))
      $("#scale_auto").trigger("change")

      // 初期設定
      $("#scale_auto").prop("checked",setting.scale_ratio.auto).trigger("change")
      $("#scale_ratio").val(setting.scale_ratio.scale_ratio).trigger("change")
      $("#scale_auto_h").val(setting.scale_ratio.min_height).trigger("change")
      $("#scale_auto_w").val(setting.scale_ratio.min_width).trigger("change")

      // 変更検知
      $("#scale_auto").on("change",function(){
        if($(this).prop("checked")){
          setting.scale_ratio.auto = true
          $("#scale_ratio_wrap").hide()
          $("#scale_auto_wrap").show()
        }
        if(!$(this).prop("checked")){
          setting.scale_ratio.auto = false
          $("#scale_ratio_wrap").show()
          $("#scale_auto_wrap").hide()
        }
        save()
      })
      function scale_auto_load(){
        if($("#scale_auto").prop("checked")){
          setting.scale_ratio.auto = true
          $("#scale_ratio_wrap").hide()
          $("#scale_auto_wrap").show()
        }
        if(!$("#scale_auto").prop("checked")){
          setting.scale_ratio.auto = false
          $("#scale_ratio_wrap").show()
          $("#scale_auto_wrap").hide()
        }
      }
      scale_auto_load()
      $("#scale_ratio").on("change",function(){
        if($(this).val() < 1){
          $(this).val(2).trigger("change")
          return false
        }
        setting.scale_ratio.scale_ratio = $(this).val()
        if($(this).val() == ""){
          setting.scale_ratio.scale_ratio = 0
          $(this).val(0)
        }
        save()
      })
      $("#scale_auto_h").on("change",function(){
        if($(this).val() == "" && $("#scale_auto_w").val() == 0){
          $(this).val(1024).trigger("change")
          return false
        }
        if($(this).val() == 0 && $("#scale_auto_w").val() == 0){
          $(this).val(1024).trigger("change")
          return false
        }
        setting.scale_ratio.min_height = $(this).val()
        if($(this).val() == ""){
          setting.scale_ratio.min_height = 0
          $(this).val(0)
        }
        save()
      })
      $("#scale_auto_w").on("change",function(){
        if($(this).val() == "" && $("#scale_auto_h").val() == 0){
          $(this).val(1024).trigger("change")
          return false
        }
        if($(this).val() == 0 && $("#scale_auto_h").val() == 0){
          $(this).val(1024).trigger("change")
          return false
        }
        setting.scale_ratio.min_width = $(this).val()
        if($(this).val() == ""){
          setting.scale_ratio.min_width = 0
          $(this).val(0)
        }
        save()
      })

      $("#parallel").val(setting.parallel).trigger("change")
      $("#parallel").on('change',function(){
        if($(this).val() == 0){
          $(this).val(1).trigger("change")
          return false
        }
        setting.parallel = $(this).val()
        save()
      })

      $("#scale_down_ratio").val(setting.scale_down_ratio).trigger("change")
      $("#scale_down_ratio").on("change",function(){
        setting.scale_down_ratio = $(this).val()
        save()
      })
      $("#scale_down_unsharp").val(setting.scale_down_unsharp).trigger("change")
      $("#scale_down_unsharp").on("change",function(){
        setting.scale_down_unsharp = $(this).val()
        save()
      })
      /////////////////////////////////////////////////////////////////
      // fileformats                                                 //
      // 入力ファイルフォーマット                                    //
      /////////////////////////////////////////////////////////////////
      function fileformats_html(){
        let answer = ""
        for(let key in setting.file_formats){
          let _this = setting.file_formats[key]
              checked = ""
          if(_this.enable) checked += "checked"
          answer += `
          <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="input_fileformats_${key}">
            <input type="checkbox" id="input_fileformats_${key}" class="mdl-checkbox__input" value="${key}" ${checked}>
            <span class="mdl-checkbox__label">${key}</span>
          </label>
          `
        }
        return answer
      }
      $("#fileformats_inputs").html(fileformats_html())
      // 変更検知
      $("input[id^='input_fileformats_']").on('change',function(){
        setting.file_formats[$(this).val()].enable = $(this).prop("checked")
        save()
      })
      /////////////////////////////////////////////////////////////////
      // output                                                      //
      // 出力設定                                                    //
      /////////////////////////////////////////////////////////////////
      function output_exts_html(){
        let answer = ""
        for(let key in setting.file_formats){
          let _this = setting.file_formats[key]
          if(_this.mime.indexOf("image") > -1){
            answer += `
            <option>${key}</option>
            `
          }
        }
        return answer
      }
      $("#output_format_image").html(output_exts_html())
      $("#output_format_image").val(setting.output.file_format).trigger("change")
      $("#output_format_image").on("change",function(){
        setting.output.file_format = $(this).val()
        $("#output_format_image_option").val(setting.file_formats[$(this).val()].output_option).trigger("change")
        save()
      })
      $("#output_format_image_option").on("change",function(){
        setting.file_formats[$("#output_format_image").val()].output_option = $(this).val()
        save()
      })

      $("#output_path").on("change",function(){
        setting.output.path = $(this).val()
        save()
      })
      $("#resetoutputpath").on("click",function(){
        $("#output_path").val("").trigger("change")
      })

      changed_files_list()
    })
    
    $(window).on('load',function(){
      setTimeout(function(){componentHandler.upgradeAllRegistered();},500)
    })
    </script>
  </head>






  <body>
    <form>
      <div class="container">
        <h1><i class="fa fa-code" aria-hidden="true"></i>%i18n:text.title%</h1>
        <p>
          %i18n:text.descriptions%
        </p>

        <h3>%i18n:text.processorder%</h3>
        <div style="display: flex; width: 100%; flex-wrap: wrap">


          <div class="mdl-card mdl-shadow--2dp m-3 flex_1">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">%i18n:text.setting.w2xbins.title%</h2>
            </div>
            <div class="mdl-card__supporting-text" id="w2xbins">
            </div>
            <div class="mdl-card__actions mdl-card--border">
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <textarea class="mdl-textfield__input" type="text" rows="1" id="w2x_option" name"w2x_option"></textarea>
                <label class="mdl-textfield__label" for="w2x_option">Option</label>
              </div>
            </div>
          </div>

          <div class="mdl-card mdl-shadow--2dp m-3 flex_1">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">%i18n:text.setting.model.title%</h2>
            </div>
            <div class="mdl-card__supporting-text">
              <h5>%i18n:text.setting.model.vendor%</h5>
              <div id="model_vendor_wrap">
                <div class="mdl-selectfield mdl-js-selectfieldm dl-textfield--floating-label p-0">
                  <select id="model_vendor" name="model_vendor" class="mdl-selectfield__select">
                  </select>
                  <label class="mdl-selectfield__label" for="model_vendor"></label>
                  <span class="mdl-selectfield__error">%i18n:text.error.selectavalue%</span>
                </div>
              </div>
              <p class="pb-1" id="model_vendor_description"></p>
              <h5>%i18n:text.setting.model.image%</h5>
              <div id="model_image_wrap">
              </div>
              <p class="pb-1" id="model_image_description"></p>
            </div>
          </div>

          <div class="mdl-card mdl-shadow--2dp m-3 flex_1">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">%i18n:text.setting.noise.title%</h2>
            </div>
            <div class="mdl-card__supporting-text" id="noise_level_wrap" style="display:flex; flex-wrap:wrap">
              <div style="flex: 4 250px">
                <input class="mdl-slider mdl-js-slider p-0" type="range" id="noise_level" min="0" max="3" step="1">
              </div>
              <div style="flex: 1 40px">
                <p class="slider_disp" id="noise_level_disp"></p>
              </div>
              <div id="auto_scale_wrap" style="display:inline-block;flex: 5 100%"></div>
            </div>
          </div>
      
          <div class="mdl-card mdl-shadow--2dp m-3 flex_1">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">%i18n:text.setting.scale.title%</h2>
            </div>
            <div class="mdl-card__supporting-text" id="noise_level_wrap">
              <div id="scale_auto_switch_wrap"></div>
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width:100%" id="scale_ratio_wrap">
                <input class="mdl-textfield__input" type="text" pattern="[0-9]*(\.[0-9]+)?" id="scale_ratio">
                <label class="mdl-textfield__label" for="scale_ratio">%i18n:text.setting.scale.ratio%</label>
                <span class="mdl-textfield__error">%i18n:text.setting.scale.numerror%</span>
              </div>
              <div id="scale_auto_wrap" style="display:flex; flex-wrap:wrap">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label flex_2">
                  <input class="mdl-textfield__input" type="text" pattern="[0-9]*([0-9]+)?" id="scale_auto_w">
                  <label class="mdl-textfield__label" for="scale_ratio">%i18n:text.setting.scale.width%</label>
                  <span class="mdl-textfield__error">%i18n:text.setting.scale.numerror2%</span>
                </div>
                <div style="flex: 1 20px; text-align:center; padding: 20px 0">x</div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label flex_2">
                  <input class="mdl-textfield__input" type="text" pattern="[0-9]*([0-9]+)?" id="scale_auto_h">
                  <label class="mdl-textfield__label" for="scale_ratio">%i18n:text.setting.scale.height%</label>
                  <span class="mdl-textfield__error">%i18n:text.setting.scale.numerror2%</span>
                </div>
                <p class="pb-1" style="flex:1 100%">%i18n:text.setting.scale.auto_description%</p>
              </div>
            </div>
          </div>

          <div class="mdl-card mdl-shadow--2dp m-3 flex_1">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">%i18n:text.setting.process.title%</h2>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width:100%">
                <input class="mdl-textfield__input" type="text" pattern="[0-9]*([0-9]+)?" id="parallel">
                <label class="mdl-textfield__label" for="parallel">%i18n:text.setting.process.number%</label>
                <span class="mdl-textfield__error">%i18n:text.setting.scale.numerror2%</span>
              </div>
            </div>
          </div>

          <div class="mdl-card mdl-shadow--2dp m-3 flex_1">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">%i18n:text.setting.scaledown.title%</h2>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width:100%">
                <input class="mdl-textfield__input" type="text" pattern="[0-9]*(\.[0-9]+)?" id="scale_down_ratio">
                <label class="mdl-textfield__label" for="scale_down_ratio">%i18n:text.setting.scaledown.number%</label>
                <span class="mdl-textfield__error">%i18n:text.setting.scale.numerror%</span>
              </div>
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width:100%">
                <input class="mdl-textfield__input" type="text" pattern="([0-9]+[x]+[0-9]+(\+[0-9]+(\.[0-9]+)?)?(\+[0-9]+(\.[0-9]+)?)?)?" id="scale_down_unsharp">
                <label class="mdl-textfield__label" for="scale_down_unsharp">%i18n:text.setting.scaledown.unsharp%</label>
                <span class="mdl-textfield__error">%i18n:text.setting.scaledown.typeerror%</span>
              </div>
            </div>
          </div>

        </div>

        <h3>%i18n:text.file_setting%</h3>
        <div style="display: flex; width: 100%; flex-wrap: wrap">

          <div class="mdl-card mdl-shadow--2dp m-3 flex_1" id="ext">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">%i18n:text.setting.ext.title%</h2>
            </div>
            <div class="mdl-card__supporting-text" id="fileformats_inputs">
            </div>
          </div>

          <div class="mdl-card mdl-shadow--2dp m-3 flex_1" id="out">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">%i18n:text.setting.out.title%</h2>
            </div>
            <div class="mdl-card__supporting-text" id="out_wrap">
              <h5>%i18n:text.setting.out.path%</h5>
              <p>%i18n:text.setting.out.path_d%</p>
              <label>
                <input type="file" id="output_path" name="output_path" webkitdirectory directory>
              </label>
              <a class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" id="resetoutputpath" name="resetoutputpath" style="margin-left: 0.25em">
                %i18n:text.setting.out.reset%
              </a>
              <h5>%i18n:text.setting.out.imgext%</h5>
              <div class="mdl-selectfield mdl-js-selectfieldm dl-textfield--floating-label p-0">
                <select id="output_format_image" name="output_format_image" class="mdl-selectfield__select">
                </select>
                <label class="mdl-selectfield__label" for="output_format_image"></label>
                <span class="mdl-selectfield__error">%i18n:text.error.selectavalue%</span>
              </div>
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <textarea class="mdl-textfield__input" type="text" rows="1" id="output_format_image_option" name"output_format_image_option"></textarea>
                <label class="mdl-textfield__label" for="output_format_image_option">Option</label>
              </div>
            </div>
          </div>

        </div>
        <h3>%i18n:text.files.chosen%</h3>
        <div id="files_chosen"></div>

      </div>

        <div class="mdl-shadow--2dp" style="position: sticky; bottom:0; right: 0; padding-top: 0.75em; padding-bottom: 0.75em; padding-right: 3em; padding-left: 3em; z-index: 1001; background-color:aliceblue">
        
        <p class="pb-0">
          %i18n:text.text_please_drop%
        </p>
        <div style="display:flex">
        <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" name="do" style="margin-left: auto;">
          %i18n:text.Run_waifu2x%
        </button>
        <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" name="PAUSE" style="margin-left: 0.25em">
          %i18n:text.PAUSE%
        </button>
        <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" name="DEL" style="margin-left: 0.25em">
          %i18n:text.DEL%
        </button>
        </div>
        </div>

      <div class="container">
        <h3>%i18n:text.files.reserved%</h3>
        <div id="files_reserved" style="padding-bottom: 1em"></div>

        <h3>%i18n:text.files.running%</h3>
        <div id="files_running" style="padding-bottom: 1em"></div>

        <h3>%i18n:text.files.finished%</h3>
        <div id="files_finished" style="padding-bottom: 1em"></div>

        <p class="pb-0">
          %i18n:i18ntest.We_are_using_node_version%<br>
          %i18n:i18ntest.Chrome_version%<br>
          %i18n:i18ntest.and_Electron_version%
        </p>
      </div>





      </form>
    <script>

      /* *************************************************************** */
      /*                                                                 */
      /* i18n                                                            */
      /*                                                                 */
      /* *************************************************************** */

      function replace_i18n(match,_1){
        if(DEBUG) console.log(match)
        if(DEBUG) console.log(_1)
        if(_1 == "(.+?)") return _1
        let a = ""
        eval('a = i18n.here.' + _1)
        if(a == undefined) eval('a = i18n.ja.' + _1)
        if(a == undefined) a = "文章がありません @" + _1
        return eval("`" + a + "`")
      }

      document.body.innerHTML = document.body.innerHTML.replace(/%i18n:(.+?)%/g,replace_i18n)
  </script>
  </body>
</html>