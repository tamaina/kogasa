<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>kogasa - waifu2x frontend</title>
    <script>
    let _module_exports = module.exports
        _noderequire = window.require
    delete module.exports
    const $ = window.jQuery = require('./assets/jquery/jquery.min.js')
    module.exports = _module_exports
    window.require = _noderequire
    delete _jquery
    delete _require
    delete _module_exports
    const fs = require('fs')
          nodecrypto = require('crypto')
    const DEBUG = true
          setting_path = "./setting.json"
          i18n = {}
          i18n["here"] = require('./locales/' + window.navigator.language + '.json')
          i18n.ja = require('./locales/ja.json')
          display_files_chosen_selector = "#files_chosen"
          display_files_running_selector = "#files_running"
          display_files_finished_selector = ""
      let files_chosen = []
          files_running = {}
          files_finished = {}
          setting = require(setting_path)
    

    // 変数設定

    if(DEBUG) console.log(i18n)

    $(document).on('dragover drop',function(e) {
      e.preventDefault()
      return false
    })

    $(function(){

      // 終了時setting.jsonを書き換える。
      $(window).on("load",function(){
        let timestamp = new Date()
        setting.log.push([timestamp.toISOString()])
        fs.writeFile(setting_path, JSON.stringify(setting,null,4))
      })
      
      // 関数type()……File APIを読み取りファイルタイプを出力
      //               returntypeはtextかisReadable
      function type(file,returntype){ 
        let answer = false
        if(fs.existsSync(file.path) && fs.statSync(file.path).isDirectory()){
          switch(returntype){
            case 'text': answer = "directory"; break;
            case 'isReadable' : answer = false; break;
          }
        } else {
          if(DEBUG) console.log(file.type)
          switch(returntype){
            case 'text': answer = file.type; break;
            case 'isReadable' : 
              for( var key in setting.file_formats ){
                if(DEBUG) console.log(key + ",mime:" + setting.file_formats[key].mime)
                if(setting.file_formats[key].mime == file.type ){
                  answer = key
                } else if ( file.path.slice( -1 * key.length ) == key ){
                  answer = key
                }
              }
              break
          }
        }
        if(DEBUG) console.log(answer)
        return answer
      }

      // 関数changed_files_list()……ファイルを入力/削除した時に実行し、ファイル一覧の変更をする
      function changed_files_list(){
        let files_chosen_html = ""
            files_running_html = ""
            delete_html_before = "<a href='javascript:void(0)' class='mdl-button mdl-js-button mdl-button--icon delete-chosen-file' name='delete_chosen_file_"
            delete_html_after = "'>&times;</a>"

        if(DEBUG) console.table(files_chosen)
        // 選択済みファイルの出力
        for(let i = 0; i < files_chosen.length; i++){
          let numbering = i + 1
              typeImage = new Image
              _this = files_chosen[i]
              mimetype = type(_this,'text')
              isReadable = type(_this,'isReadable')
              imageWidth = 0
              imageHeight = 0
          if(isReadable){
            typeImage.src = new FileReader().readAsDataURL(_this)
          }
          files_chosen_html += "<p class='changeable pb-0'>" + numbering + " " + delete_html_before + i + delete_html_after + _this.path + " (" + mimetype
          if(DEBUG) console.table()
          if(isReadable){
            imageWidth = typeImage.width
            imageHeight = typeImage.height
            files_chosen_html += "," + isReadable + "," + Number(_this.size) + "," + imageWidth + "x" + imageHeight + ")" + "</p>"
          } else {
            files_chosen_html +=")" + "</p>"
          }
        }
        $(display_files_chosen_selector).html(files_chosen_html.replace(/%i18n:(.+?)%/g,replace_i18n))
        
        if(DEBUG) console.table(files_running)

        // 処理中ファイル一覧の出力
        if(files_running){
        for(let key in files_running){
          let typeImage = new Image
              _this = files_running[key].file
              mimetype = type(_this,'text')
              isReadable = type(_this,'isReadable')
              imageWidth = 0
              imageHeight = 0
          if(isReadable){
            typeImage.src = new FileReader().readAsDataURL(_this)
          }
          files_running_html += "<p class='changeable pb-0'>" + "id:" + key + " (" + mimetype
          if(DEBUG) console.table()
          if(isReadable){
            imageWidth = typeImage.width
            imageHeight = typeImage.height
            files_running_html += "," + isReadable + "," + Number(_this.size) + "," + imageWidth + "x" + imageHeight + ")" + "</p>"
          } else {
            files_running_html +=")" + "</p>"
          }
        }
        $(display_files_running_selector).html(files_running_html.replace(/%i18n:(.+?)%/g,replace_i18n))
        }
        $(".delete-chosen-file").off('click')
        $(".delete-chosen-file").on("click",function(){
          if(DEBUG) console.log("delete!")
          let index = 0
          index = $(".delete-chosen-file").index(this)
          if(DEBUG) console.log(index)
          if( files_chosen.length > 1 ) files_chosen.splice( Number(index) , 1 )
          else files_chosen = []
          changed_files_list()
        })

      }

      //id発行
      function get_hash(timestamp) {
        if(DEBUG) console.log(crypto)
        return nodecrypto.createHash('sha1').update(timestamp).digest("hex")
      }

      // waifu2x実行
      function w2x_run(file){
        let timestamp = new Date()
        if(DEBUG) console.log("started at " + timestamp.toISOString())
        let id = get_hash(timestamp.toISOString())
        files_running[id] = {}
        files_running[id]["file"] = file
        files_running[id]["file"]["file_format"] = type(file,'isReadable')
        files_running[id]["order"] = setting
        changed_files_list()
      }

      // DD時の動作
      $(document).on('drop',function(e){
        e.preventDefault();
        let this_input = e.originalEvent.dataTransfer.files
        let buffer = new Array
        if(DEBUG) console.table(this_input)
        if(DEBUG) console.table(files_chosen)
        Array.prototype.push.apply(buffer,this_input)
        Array.prototype.push.apply(buffer,files_chosen)
        files_chosen = buffer.filter(function(element, index, array){
          if(DEBUG) console.log(element)
          if(DEBUG) console.log(index)
          if(DEBUG) console.log(array)
          var can_add = true
          for(let i = 0; i < array.length; i++){
            if( i != index && array[i].path == element.path ) can_add = false
            else if(i == index) can_add = true
          }
          if(DEBUG) console.log(can_add)
          return can_add
        })
        changed_files_list()
      })

      // 実行ボタン監視
      $("button[name='do']").on('click',function(e){
        e.preventDefault()
        for(let i = 0; i < files_chosen.length; i++ ){
          if($(`#input_fileformats_${type(files_chosen[i],'isReadable')}`).prop('checked') == true){
            w2x_run(files_chosen[i])
          } else if(type(files_chosen[i],'text') == 'directory') {
            w2x_directory(files_chosen[i])
          }
        }
        files_chosen = []
        changed_files_list()
      })
      $("button[name='DEL']").on('click',function(e){ e.preventDefault(); files_chosen = []; changed_files_list() })
      
      // fileformatsの設定html出力
      function fileformats_html(){
        let answer = ""
        for(let key in setting.file_formats){
          let _this = setting.file_formats[key]
          answer += `
          <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="input_fileformats_${key}">
            <input type="checkbox" id="input_fileformats_${key}" class="mdl-checkbox__input" checked>
            <span class="mdl-checkbox__label">${key}</span>
          </label>
          `
        }
        return answer
      }
      $("#fileformats_inputs").html(fileformats_html())

    })
    $(window).on('load',function(){
      componentHandler.upgradeDom();
    })
    </script>
    <link rel="stylesheet" href="./assets/mdl/material.min.css">
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./assets/fa/css/font-awesome.min.css">
    <script src="./assets/mdl/material.min.js"></script>
  </head>






  <body>
    <div class="container">
      <h1><i class="fa fa-code" aria-hidden="true"></i>%i18n:i18ntest.Hello_World%</h1>
      <p>
        %i18n:i18ntest.We_are_using_node_version%<br>
        %i18n:i18ntest.Chrome_version%<br>
        %i18n:i18ntest.and_Electron_version%
      </p>
      <p>%i18n:i18ntest.OSis_platform%
        %i18n:i18ntest.OS_arch_is_arch%
      </p>
      <form>

      
      <div class="mdl-card mdl-shadow--2dp" id="ext">
        <div class="mdl-card__title">
          <h2 class="mdl-card__title-text">%i18n:text.setting.ext.title%</h2>
        </div>
        <div class="mdl-card__supporting-text" id="fileformats_inputs">
        </div>
      </div>

      <p>
        %i18n:text.text_please_drop%
      </p>
      <div id="files_chosen"></div>
      <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" name="do">
        %i18n:text.Run_waifu2x%
      </button>
      <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" name="DEL">
        %i18n:text.DEL%
      </button>

      <h3>処理中ファイル</h3>
      <div id="files_running"></div>

      </form>
    </div>





    <script>
      function replace_i18n(match,_1){
        if(DEBUG) console.log(match)
        if(DEBUG) console.log(_1)
        if(_1 == "(.+?)") return _1
        let a = ""
        eval('a = i18n.here.' + _1)
        if(a == undefined) eval('a = i18n.ja.' + _1)
        if(a == undefined) a = "文章がありません @" + _1
        return eval("`" + a + "`")
      }

      document.body.innerHTML = document.body.innerHTML.replace(/%i18n:(.+?)%/g,replace_i18n)
  </script>
  </body>
</html>